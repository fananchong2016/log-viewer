<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <meta charset="utf-8" />
    <title>Log Viewer</title>
</head>

<body style="height: 100%; margin: 0; display: flex; flex-direction: column; font-family: sans-serif;">

    <div style="padding: 3px; background: #2d2d2d; display: flex; align-items: center; gap: 12px;">
        <!-- å·¦åŠéƒ¨åˆ†ï¼šæœç´¢åŒºåŸŸ -->
        <div
            style="flex: 1; display: flex; align-items: center; background: #3a3a3a; border: 1px solid #555; border-radius: 6px; padding: 4px;">
            <div style="color: #4CAF50; font-weight: bold; font-size: 12px; margin-right: 8px; white-space: nowrap;">ğŸ”
                æœç´¢</div>
            <input id="search" type="text" placeholder="Search logs..."
                style="flex: 1; padding: 4px 6px; border: 1px solid #666; border-radius: 3px; background: #2a2a2a; color: white;" />

            <!-- å¿«é€Ÿæœç´¢æ ‡ç­¾ -->
            <div id="quickSearchLabels" style="display: flex; align-items: center; gap: 8px; margin-left: 8px;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å¿«é€Ÿæœç´¢æ ‡ç­¾å°†åœ¨è¿™é‡Œ -->
            </div>

            <button id="clearLogBtn"
                style="margin-left: 8px; padding: 3px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">æ¸…é™¤æ—¥å¿—</button>
            <div id="status" style="color: white; margin-left: 6px; white-space: nowrap;"></div>
        </div>

        <!-- å³åŠéƒ¨åˆ†ï¼šGMæŒ‡ä»¤åŒºåŸŸ -->
        <div
            style="flex: 1; display: flex; align-items: center; background: #4a3a4a; border: 1px solid #665566; border-radius: 6px; padding: 4px;">
            <div style="color: #FF9800; font-weight: bold; font-size: 12px; margin-right: 8px; white-space: nowrap;">âš¡
                GMæŒ‡ä»¤</div>
            <input id="gmCommand" type="text" placeholder="è¯·è¾“å…¥GMæŒ‡ä»¤..."
                style="flex: 1; padding: 4px 6px; border: 1px solid #776677; border-radius: 3px; background: #3a2a3a; color: white;" />
        </div>
    </div>

    <pre id="log"
        style="flex: 1; background: #1e1e1e; color: white; margin: 0; padding: 10px; overflow: auto; white-space: pre-wrap;"></pre>

    <div id="matches"
        style="max-height: 100px; overflow-y: auto; background: #3a3a3a; color: #ccc; font-size: 12px; border: 1px solid #4CAF50; border-radius: 4px; padding: 4px; margin: 3px; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">
    </div>

    <script>
        // Webview ä¸»é€»è¾‘
        class LogViewer {
            constructor() {
                try {
                    this.vscode = acquireVsCodeApi();
                } catch (error) {
                    console.error('Failed to acquire VS Code API:', error);
                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„ vscode API ç”¨äºå¼€å‘æµ‹è¯•
                    this.vscode = {
                        postMessage: (msg) => console.log('Mock postMessage:', msg),
                        getState: () => null,
                        setState: (state) => console.log('Mock setState:', state)
                    };
                }

                this.currentLogLines = [];
                this.matchPositions = [];
                this.currentMatchIndex = -1;
                this.searchHistory = [];
                this.historyIndex = -1;
                this.searchTimeout = null;

                // å¿«é€Ÿæœç´¢å…³é”®è¯ - é»˜è®¤å€¼ï¼Œä¼šè¢«åç«¯é…ç½®è¦†ç›–
                this.quickSearchKeywords = ['all_succ', 'traceback'];

                // å¿«é€Ÿæœç´¢æ ‡ç­¾é¢œè‰²é…ç½® - å¯é…ç½®çš„é¢œè‰²æ•°ç»„
                this.quickSearchColors = ['#4CAF50', '#FF9800', '#E91E63', '#2196F3', '#9C27B0', '#FF5722'];

                // å¿«é€Ÿæœç´¢è®¡æ•°å™¨ - åŠ¨æ€ç”Ÿæˆ
                this.quickSearchCounts = new Map();
                this.quickSearchLabels = new Map(); // å­˜å‚¨æ ‡ç­¾å…ƒç´ çš„å¼•ç”¨
                this._isInitialized = false; // åˆå§‹åŒ–çŠ¶æ€æ ‡å¿—

                this.initElements();
                this.initEventListeners();
                this.hideMatchesDiv(); // åˆå§‹åŒ–æ—¶éšè—åŒ¹é…æ 
                this.restoreState();
                this.requestInitialState();

                // åˆå§‹åŒ–å¿«é€Ÿæœç´¢è®¡æ•°å™¨ - å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…åˆå§‹åŒ–æ—¶çš„é‡å¤è°ƒç”¨
                setTimeout(() => {
                    this.checkAndUpdateQuickSearchCounts();
                }, 100);
            }

            initElements() {
                this.log = document.getElementById('log');
                this.search = document.getElementById('search');
                this.status = document.getElementById('status');
                this.matchesDiv = document.getElementById('matches');
                this.clearLogBtn = document.getElementById('clearLogBtn');

                // å¿«é€Ÿæœç´¢æ ‡ç­¾å®¹å™¨
                this.quickSearchLabelsContainer = document.getElementById('quickSearchLabels');
            }

            initEventListeners() {
                // æ¶ˆæ¯ç›‘å¬
                window.addEventListener('message', this.handleMessage.bind(this));

                // æ¸…é™¤æ—¥å¿—æŒ‰é’®
                this.clearLogBtn.addEventListener('click', this.clearLog.bind(this));

                // æœç´¢ç›¸å…³äº‹ä»¶
                this.search.addEventListener('keydown', this.handleSearchKeydown.bind(this));

                // åŒ¹é…é¡¹ç‚¹å‡»äº‹ä»¶å§”æ‰˜
                this.matchesDiv.addEventListener('click', this.handleMatchesDivClick.bind(this));

                // å¿«é€Ÿæœç´¢æ ‡ç­¾ç‚¹å‡»äº‹ä»¶å§”æ‰˜
                this.quickSearchLabelsContainer.addEventListener('click', this.handleQuickSearchClick.bind(this));

                // å¿«é€Ÿæœç´¢æ ‡ç­¾ç‚¹å‡»äº‹ä»¶å°†é€šè¿‡äº‹ä»¶å§”æ‰˜å¤„ç†

                // å®šæœŸä¿å­˜çŠ¶æ€
                setInterval(() => this.persistState(), 1000);
            }

            handleMessage(event) {
                const { type, lines, history, payload, targetLineIndex, colors } = event.data;

                switch (type) {
                    case 'history':
                        this.handleHistory(history);
                        break;
                    case 'restorePanelState':
                        this.handleRestorePanelState(payload);
                        break;
                    case 'log':
                        this.handleLog(lines, targetLineIndex);
                        break;
                    case 'searchResult':
                        this.handleSearchResult(payload);
                        break;
                    case 'updateQuickSearchCounts':
                        this.handleUpdateQuickSearchCounts(payload, colors);
                        break;
                    case 'updateQuickSearchColors':
                        this.updateQuickSearchColors(payload);
                        break;
                }
            }

            handleHistory(history) {
                console.log('æ”¶åˆ°å†å²è®°å½•:', history);
                if (Array.isArray(history)) {
                    this.searchHistory = [...history];
                    this.historyIndex = this.searchHistory.length;
                    console.log('å†å²è®°å½•å·²åŠ è½½ï¼Œå…±', this.searchHistory.length, 'æ¡');
                } else {
                    console.warn('å†å²è®°å½•æ ¼å¼é”™è¯¯:', history);
                    this.searchHistory = [];
                    this.historyIndex = 0;
                }
            }

            handleRestorePanelState(payload) {
                if (payload.searchText) {
                    this.search.value = payload.searchText;
                    this.currentMatchIndex = payload.matchIndex || -1;
                    setTimeout(() => this.applySearch(this.search.value), 50);
                } else {
                    this.hideMatchesDiv();
                }
                if (payload.scrollTop !== undefined) {
                    setTimeout(() => { this.log.scrollTop = payload.scrollTop; }, 100);
                }
            }

            handleLog(lines, targetLineIndex) {
                this.currentLogLines = lines || [];

                // æ›´æ–°å¿«é€Ÿæœç´¢è®¡æ•°å™¨ - åªåœ¨æœ‰å®é™…æ—¥å¿—æ•°æ®æ—¶æ›´æ–°
                if (lines && lines.length > 0) {
                    this.checkAndUpdateQuickSearchCounts();
                }

                if (!this.search.value.trim()) {
                    this.renderLogLines();
                } else {
                    setTimeout(() => {
                        if (targetLineIndex !== undefined) {
                            this.highlightTargetLine(targetLineIndex);
                        } else {
                            this.highlightLogContent(this.search.value.trim());
                        }
                    }, 10);
                }
            }

            handleSearchResult(payload) {
                setTimeout(() => {
                    this.matchPositions = payload;
                    this.applySearch(this.search.value.trim());
                }, 0);
            }

            handleSearchKeydown(e) {
                if (e.key === 'Enter') {
                    this.clearSearchHighlights();
                    const query = this.search.value.trim();
                    this.sendSearchRequest();

                    if (!query) return;

                    this.updateSearchHistory(query);
                } else if (e.key === 'ArrowUp') {
                    this.navigateHistory(-1);
                } else if (e.key === 'ArrowDown') {
                    this.navigateHistory(1);
                }
            }

            navigateHistory(direction) {
                if (this.searchHistory.length === 0) return;

                if (direction === -1) {
                    this.historyIndex = Math.max(0, this.historyIndex - 1);
                    this.search.value = this.searchHistory[this.historyIndex];
                } else {
                    this.historyIndex = Math.min(this.searchHistory.length, this.historyIndex + 1);
                    if (this.historyIndex === this.searchHistory.length) {
                        this.search.value = '';
                    } else {
                        this.search.value = this.searchHistory[this.historyIndex];
                    }
                }
            }

            updateSearchHistory(query) {
                if (!query || query.trim() === '') return;

                console.log('æ›´æ–°æœç´¢å†å²:', query);

                if (!this.searchHistory.includes(query)) {
                    this.searchHistory.push(query);
                    if (this.searchHistory.length > 100) {
                        this.searchHistory = this.searchHistory.slice(-100);
                    }
                } else {
                    this.searchHistory.splice(this.searchHistory.indexOf(query), 1);
                    this.searchHistory.push(query);
                }

                console.log('å½“å‰å†å²è®°å½•:', this.searchHistory);
                this.vscode.postMessage({ type: 'updateHistory', payload: this.searchHistory });
                this.historyIndex = this.searchHistory.length;
            }

            applySearch(query) {
                if (!query) {
                    this.clearSearchHighlights();
                    this.renderLogLines();
                    this.hideMatchesDiv();
                    return;
                }

                this.showMatchesDiv();
                const currentMatchPositions = [...this.matchPositions];

                if (currentMatchPositions.length === 0) {
                    this.status.textContent = '0 / 0';
                    this.matchesDiv.innerHTML = '<div style="color:#888;">No matches found.</div>';
                    this.renderLogLines();
                    return;
                }

                const fragments = this.createSearchFragments(currentMatchPositions, query);
                this.updateCurrentMatchIndex(currentMatchPositions);
                this.updateStatus(currentMatchPositions);
                this.updateMatchList(fragments, currentMatchPositions);
                this.persistState();
            }

            createSearchFragments(matchPositions, query) {
                const fragments = [];

                for (let i = 0; i < matchPositions.length; i++) {
                    const { index, content, contentHash } = matchPositions[i];
                    let highlighted = '';

                    // å¤„ç†å†…å®¹ä¸­çš„è½¬ä¹‰å­—ç¬¦
                    const processedContent = this.processLogLine(content);

                    if (i === this.currentMatchIndex) {
                        highlighted = this.escapeHTML(processedContent).replace(new RegExp(this.escapeRegExp(query), 'gi'), match => {
                            return `<mark id="active" style="background: yellow; color: black;">${this.escapeHTML(match)}</mark>`;
                        });
                    } else {
                        highlighted = this.escapeHTML(processedContent).replace(new RegExp(this.escapeRegExp(query), 'gi'), match => {
                            return `<span style="background: rgba(255, 255, 0, 0.5); color: black;">${this.escapeHTML(match)}</span>`;
                        });
                    }

                    fragments.push({ index, context: highlighted, contentHash });
                }

                return fragments;
            }

            // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            updateCurrentMatchIndex(matchPositions) {
                if (this.currentMatchIndex >= matchPositions.length) {
                    this.currentMatchIndex = matchPositions.length > 0 ? 0 : -1;
                }
            }

            updateStatus(matchPositions) {
                this.status.textContent = this.currentMatchIndex >= 0
                    ? `${this.currentMatchIndex + 1} / ${matchPositions.length}`
                    : `0 / ${matchPositions.length}`;
            }

            updateMatchList(fragments, matchPositionsData) {
                if (this.matchesDiv.children.length > 0 && this.matchesDiv.children.length === fragments.length) {
                    this.updateMatchListContent(fragments, matchPositionsData);
                } else {
                    this.renderMatchList(fragments, matchPositionsData);
                }
            }

            renderMatchList(list, matchPositionsData) {
                this.matchesDiv.innerHTML = '';

                for (let i = 0; i < list.length; i++) {
                    const item = list[i];
                    const div = this.createMatchItem(i, item, matchPositionsData);
                    this.matchesDiv.appendChild(div);
                }
            }

            createMatchItem(index, item, matchPositionsData) {
                const div = document.createElement('div');
                div.innerHTML = `<span style="cursor:pointer; color:#6cf;">[${index + 1}]</span> ${item.context}`;
                div.style.padding = '2px 4px';
                div.style.borderBottom = '1px solid #4CAF50';
                div.style.cursor = 'pointer';
                div.style.pointerEvents = 'auto';
                div.style.whiteSpace = 'nowrap';
                div.style.overflow = 'hidden';
                div.style.textOverflow = 'ellipsis';
                div.style.borderRadius = '2px';
                div.style.margin = '1px 0';
                div.style.transition = 'background-color 0.2s ease, border 0.2s ease, box-shadow 0.2s ease';
                div.style.lineHeight = '1.2';

                // è®¾ç½®æ•°æ®å±æ€§
                div.dataset.matchIndex = index;
                div.dataset.logIndex = matchPositionsData[index].index;
                div.dataset.contentHash = matchPositionsData[index].contentHash;

                this.updateMatchItemHighlight(div, index);

                return div;
            }

            updateMatchItemHighlight(div, index) {
                if (index === this.currentMatchIndex && this.currentMatchIndex >= 0) {
                    div.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
                    div.style.border = '1px solid #4CAF50';
                    div.style.boxShadow = '0 0 4px rgba(76, 175, 80, 0.4)';
                } else {
                    div.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                    div.style.border = '1px solid transparent';
                    div.style.boxShadow = 'none';
                }
            }

            handleMatchesDivClick(event) {
                // äº‹ä»¶å§”æ‰˜å¤„ç†åŒ¹é…é¡¹ç‚¹å‡»
                const target = event.target.closest('div[data-match-index]');
                if (!target) return;

                const matchIndex = parseInt(target.dataset.matchIndex);
                const logIndex = parseInt(target.dataset.logIndex);
                const contentHash = target.dataset.contentHash;

                this.currentMatchIndex = matchIndex;
                this.status.textContent = `${this.currentMatchIndex + 1} / ${this.matchPositions.length}`;
                this.updateMatchListHighlight();

                this.vscode.postMessage({
                    type: 'getLogByIndex',
                    index: logIndex,
                    contentHash: contentHash
                });
            }

            handleQuickSearchClick(event) {
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œæ‰¾åˆ°è¢«ç‚¹å‡»çš„å¿«é€Ÿæœç´¢æ ‡ç­¾
                const target = event.target.closest('.quick-search-label');
                if (!target) return;

                const searchText = target.dataset.search;
                if (searchText) {
                    console.log('å¿«é€Ÿæœç´¢æ ‡ç­¾è¢«ç‚¹å‡»:', searchText);
                    this.search.value = searchText;
                    this.search.focus();

                    // è‡ªåŠ¨è§¦å‘æœç´¢
                    this.sendSearchRequest();
                    this.updateSearchHistory(searchText);
                }
            }

            handleUpdateQuickSearchCounts(payload, colors) {
                // æ›´æ–°è®¡æ•°å™¨ - ä½¿ç”¨åç«¯æä¾›çš„æ•°æ®ï¼Œé¿å…æœ¬åœ°è®¡ç®—å†²çª
                Object.keys(payload).forEach(keyword => {
                    this.quickSearchCounts.set(keyword, payload[keyword]);
                });

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ”¶åˆ°æ•°æ®ï¼Œä»åç«¯è·å–å…³é”®è¯é…ç½®å¹¶åˆå§‹åŒ–æ ‡ç­¾
                if (this.quickSearchLabels.size === 0) {
                    // ä»è®¡æ•°å™¨æ•°æ®ä¸­æå–å…³é”®è¯åˆ—è¡¨
                    this.quickSearchKeywords = Object.keys(payload);

                    // å¦‚æœåç«¯æä¾›äº†é¢œè‰²é…ç½®ï¼Œä½¿ç”¨åç«¯çš„é…ç½®
                    if (colors && Array.isArray(colors) && colors.length > 0) {
                        this.quickSearchColors = [...colors];
                        console.log('ä½¿ç”¨åç«¯æä¾›çš„é¢œè‰²é…ç½®:', this.quickSearchColors);
                    }

                    this.initializeQuickSearchLabels();
                    // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
                    this._isInitialized = true;
                } else {
                    // å¦‚æœæ ‡ç­¾å·²ç»å­˜åœ¨ï¼Œåªæ›´æ–°è®¡æ•°å™¨æ˜¾ç¤º
                    this.updateQuickSearchCounts();
                }
            }

            // æ›´æ–°å¿«é€Ÿæœç´¢æ ‡ç­¾é¢œè‰²é…ç½®
            updateQuickSearchColors(newColors) {
                if (Array.isArray(newColors) && newColors.length > 0) {
                    this.quickSearchColors = [...newColors];
                    console.log('å¿«é€Ÿæœç´¢æ ‡ç­¾é¢œè‰²é…ç½®å·²æ›´æ–°:', this.quickSearchColors);
                }
            }

            initializeQuickSearchLabels() {
                // æ¸…ç©ºå®¹å™¨
                this.quickSearchLabelsContainer.innerHTML = '';

                // ä¸ºæ¯ä¸ªå…³é”®è¯åˆ›å»ºæ ‡ç­¾
                Array.from(this.quickSearchKeywords).forEach((keyword, index) => {
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'quick-search-label';
                    labelDiv.dataset.search = keyword;
                    labelDiv.title = `ç‚¹å‡»æœç´¢: ${keyword}`; // æ·»åŠ æç¤ºä¿¡æ¯

                    // ä½¿ç”¨å¯é…ç½®çš„é¢œè‰²æ•°ç»„
                    const color = this.quickSearchColors[index % this.quickSearchColors.length];

                    labelDiv.style.cssText = `
                        color: ${color}; 
                        font-size: 11px; 
                        cursor: pointer; 
                        padding: 2px 6px; 
                        border-radius: 3px; 
                        background: ${color}20; 
                        border: 1px solid ${color}50;
                        margin-right: 8px;
                        transition: all 0.2s ease;
                        user-select: none;
                    `;

                    // æ·»åŠ æ‚¬åœæ•ˆæœ
                    labelDiv.addEventListener('mouseenter', () => {
                        labelDiv.style.background = `${color}40`;
                        labelDiv.style.transform = 'scale(1.05)';
                    });

                    labelDiv.addEventListener('mouseleave', () => {
                        labelDiv.style.background = `${color}20`;
                        labelDiv.style.transform = 'scale(1)';
                    });

                    // åˆ›å»ºè®¡æ•°å™¨span
                    const countSpan = document.createElement('span');
                    countSpan.id = `count_${keyword}`;
                    countSpan.style.cssText = `
                        background: ${color}; 
                        color: white; 
                        padding: 1px 4px; 
                        border-radius: 2px; 
                        font-size: 10px; 
                        margin-left: 4px;
                    `;
                    countSpan.textContent = '0';

                    // è®¾ç½®æ ‡ç­¾å†…å®¹
                    labelDiv.innerHTML = `${keyword} `;
                    labelDiv.appendChild(countSpan);

                    // å­˜å‚¨å¼•ç”¨
                    this.quickSearchLabels.set(keyword, labelDiv);

                    // æ·»åŠ åˆ°å®¹å™¨
                    this.quickSearchLabelsContainer.appendChild(labelDiv);
                });
            }

            handleMatchItemClick(index, matchPositionsData) {
                // ä¿ç•™æ­¤æ–¹æ³•ç”¨äºå‘åå…¼å®¹ï¼Œä½†ç°åœ¨ä½¿ç”¨äº‹ä»¶å§”æ‰˜
                this.currentMatchIndex = index;
                this.status.textContent = `${this.currentMatchIndex + 1} / ${matchPositionsData.length}`;
                this.updateMatchListHighlight();

                const matchPosition = matchPositionsData[index];
                if (matchPosition) {
                    this.vscode.postMessage({
                        type: 'getLogByIndex',
                        index: matchPosition.index,
                        contentHash: matchPosition.contentHash
                    });
                }
            }

            updateMatchListHighlight() {
                const matchItems = this.matchesDiv.querySelectorAll('div');
                matchItems.forEach((div, index) => {
                    this.updateMatchItemHighlight(div, index);
                });
            }

            updateMatchListContent(fragments, matchPositionsData) {
                const matchItems = this.matchesDiv.querySelectorAll('div');
                const maxItems = Math.min(fragments.length, matchItems.length);

                for (let i = 0; i < maxItems; i++) {
                    const div = matchItems[i];
                    const fragment = fragments[i];
                    div.innerHTML = `<span style="cursor:pointer; color:#6cf;">[${i + 1}]</span> ${fragment.context}`;
                    this.updateMatchItemHighlight(div, i);

                    // æ›´æ–°æ•°æ®å±æ€§ï¼Œç”¨äºäº‹ä»¶å§”æ‰˜
                    div.dataset.matchIndex = i;
                    div.dataset.logIndex = matchPositionsData[i].index;
                    div.dataset.contentHash = matchPositionsData[i].contentHash;
                }

                if (fragments.length !== matchItems.length) {
                    this.renderMatchList(fragments, matchPositionsData);
                }
            }

            highlightLogContent(query) {
                if (!query || this.matchPositions.length === 0) return;

                const regex = new RegExp(this.escapeRegExp(query), 'gi');
                this.log.innerHTML = '';

                this.currentLogLines.forEach((line, index) => {
                    const lineDiv = this.createLogLineDiv(index);
                    const processedLine = this.processLogLine(line);
                    const highlightedLine = this.escapeHTML(processedLine).replace(regex, match => {
                        return `<span style="background: rgba(255, 255, 0, 0.5); color: black;">${this.escapeHTML(match)}</span>`;
                    });
                    lineDiv.innerHTML = highlightedLine;
                    this.log.appendChild(lineDiv);
                });
            }

            highlightTargetLine(targetLineIndex) {
                if (targetLineIndex < 0 || targetLineIndex >= this.currentLogLines.length) return;

                const targetLine = this.currentLogLines[targetLineIndex];
                if (!targetLine) return;

                this.log.innerHTML = '';

                this.currentLogLines.forEach((line, index) => {
                    const lineDiv = this.createLogLineDiv(index);

                    if (index === targetLineIndex) {
                        lineDiv.id = 'here';
                        lineDiv.style.background = 'linear-gradient(90deg, rgba(255, 255, 0, 0.4), rgba(255, 255, 0, 0.2))';
                        lineDiv.style.borderLeft = '4px solid #ffeb3b';
                        lineDiv.style.padding = '2px 4px';
                        lineDiv.style.margin = '1px 0';
                        lineDiv.style.boxShadow = '0 0 8px rgba(255, 255, 0, 0.3)';
                    }

                    const processedLine = this.processLogLine(line);
                    lineDiv.textContent = processedLine;
                    this.log.appendChild(lineDiv);
                });

                this.scrollToTargetLine();
            }

            createLogLineDiv(index) {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'log-line';
                lineDiv.dataset.lineIndex = index;
                lineDiv.style.whiteSpace = 'pre-wrap';
                lineDiv.style.wordBreak = 'break-all';
                return lineDiv;
            }

            scrollToTargetLine() {
                setTimeout(() => {
                    const targetDiv = this.log.querySelector('#here');
                    if (targetDiv) {
                        const targetOffsetTop = targetDiv.offsetTop;
                        this.log.scrollTop = targetOffsetTop - this.log.clientHeight / 2 + targetDiv.clientHeight / 2;
                    }
                }, 10);
            }

            renderLogLines() {
                const needScroll = this.isAtBottom();
                if (!needScroll) {
                    return;
                }
                this.log.innerHTML = '';
                this.currentLogLines.forEach((line, index) => {
                    const lineDiv = this.createLogLineDiv(index);
                    // å¤„ç† JSON ä¸­çš„ \n å­—ç¬¦ï¼Œè½¬æ¢ä¸ºå®é™…æ¢è¡Œ
                    const processedLine = this.processLogLine(line);
                    lineDiv.textContent = processedLine;
                    this.log.appendChild(lineDiv);
                });
                if (needScroll) {
                    this.log.scrollTop = this.log.scrollHeight;
                }

                // ç§»é™¤è¿™é‡Œçš„å¿«é€Ÿæœç´¢è®¡æ•°å™¨æ›´æ–°ï¼Œé¿å…é‡å¤è°ƒç”¨
                // è®¡æ•°å™¨æ›´æ–°å·²ç»åœ¨ handleLog ä¸­å¤„ç†
            }

            clearSearchHighlights() {
                this.matchPositions = [];
                this.currentMatchIndex = -1;
                this.status.textContent = '';
                this.matchesDiv.innerHTML = '';
                this.persistState();
            }

            showMatchesDiv() {
                this.matchesDiv.style.display = 'block';
            }

            hideMatchesDiv() {
                this.matchesDiv.style.display = 'none';
            }

            clearLog() {
                this.currentLogLines = [];
                this.log.innerHTML = '';

                // é‡ç½®æ‰€æœ‰å¿«é€Ÿæœç´¢è®¡æ•°å™¨
                Array.from(this.quickSearchKeywords).forEach(keyword => {
                    this.quickSearchCounts.set(keyword, 0);
                });
                this.updateQuickSearchCounts();

                this.vscode.postMessage({ type: 'clearLog' });
            }

            sendSearchRequest() {
                this.vscode.postMessage({
                    type: 'searchLog',
                    query: this.search.value.trim(),
                });
            }

            escapeHTML(str) {
                return str.replace(/[&<>"']/g, s => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
                }[s]));
            }

            restoreState() {
                const cached = this.vscode.getState();
                if (cached) {
                    if (cached.searchText) this.search.value = cached.searchText;
                    if (cached.matchIndex !== undefined) this.currentMatchIndex = cached.matchIndex;
                }
            }

            requestInitialState() {
                this.vscode.postMessage({ type: 'getStateRequest' });
            }

            persistState() {
                this.vscode.setState({
                    searchText: this.search.value.trim(),
                    matchIndex: this.currentMatchIndex,
                    scrollTop: this.log.scrollTop,
                });
                this.vscode.postMessage({
                    type: 'updatePanelState',
                    payload: {
                        searchText: this.search.value.trim(),
                        matchIndex: this.currentMatchIndex,
                        scrollTop: this.log.scrollTop,
                    }
                });
            }

            // å¤„ç†æ—¥å¿—è¡Œä¸­çš„è½¬ä¹‰å­—ç¬¦
            processLogLine(line) {
                if (!line) return line;

                // å¤„ç†å¸¸è§çš„è½¬ä¹‰å­—ç¬¦
                return line
                    .replace(/\\n/g, '\n')        // \n -> æ¢è¡Œ
                    .replace(/\\t/g, '\t')        // \t -> åˆ¶è¡¨ç¬¦
                    .replace(/\\r/g, '\r')        // \r -> å›è½¦
                    .replace(/\\"/g, '"')         // \" -> åŒå¼•å·
                    .replace(/\\'/g, "'")         // \' -> å•å¼•å·
                    .replace(/\\\\/g, '\\');      // \\ -> åæ–œæ 
            }

            // åˆ¤æ–­æ˜¯å¦åœ¨åº•éƒ¨ï¼ˆç²¾ç¡®åˆ¤æ–­ï¼‰
            isAtBottom() {
                const threshold = 1; // å…è®¸1åƒç´ çš„è¯¯å·®
                return Math.abs(this.log.scrollTop + this.log.clientHeight - this.log.scrollHeight) <= threshold;
            }

            // æ›´æ–°å¿«é€Ÿæœç´¢è®¡æ•°å™¨
            updateQuickSearchCounts() {
                this.quickSearchCounts.forEach((count, keyword) => {
                    const countSpan = document.getElementById(`count_${keyword}`);
                    if (countSpan) {
                        countSpan.textContent = count.toString();
                    }
                });
            }

            // æ£€æŸ¥å¹¶æ›´æ–°å¿«é€Ÿæœç´¢è®¡æ•°
            checkAndUpdateQuickSearchCounts() {
                // åœ¨åˆå§‹åŒ–å®Œæˆå‰ï¼Œä¸æ‰§è¡Œæœ¬åœ°è®¡ç®—
                if (!this._isInitialized) {
                    return;
                }

                // é˜²æŠ–ï¼šé¿å…çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
                if (this._quickSearchUpdateTimer) {
                    clearTimeout(this._quickSearchUpdateTimer);
                }

                this._quickSearchUpdateTimer = setTimeout(() => {
                    this._performQuickSearchUpdate();
                }, 50);
            }

            // å®é™…æ‰§è¡Œå¿«é€Ÿæœç´¢æ›´æ–°çš„æ–¹æ³•
            _performQuickSearchUpdate() {
                // é‡ç½®æ‰€æœ‰è®¡æ•°å™¨
                Array.from(this.quickSearchKeywords).forEach(keyword => {
                    this.quickSearchCounts.set(keyword, 0);
                });

                // æ£€æŸ¥å½“å‰æ—¥å¿—ç¼“å†²åŒºä¸­çš„åŒ¹é…
                this.currentLogLines.forEach(line => {
                    Array.from(this.quickSearchKeywords).forEach(keyword => {
                        if (line.toLowerCase().includes(keyword.toLowerCase())) {
                            const currentCount = this.quickSearchCounts.get(keyword) || 0;
                            this.quickSearchCounts.set(keyword, currentCount + 1);
                        }
                    });
                });

                this.updateQuickSearchCounts();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initLogViewer() {
            try {
                new LogViewer();
            } catch (error) {
                console.error('Failed to initialize LogViewer:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.body.innerHTML = `
                    <div style="padding: 20px; color: white; background: #1e1e1e; height: 100%;">
                        <h3>Log Viewer åˆå§‹åŒ–å¤±è´¥</h3>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <button onclick="location.reload()" style="padding: 8px 16px; margin-top: 10px;">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
            }
        }

        // ç­‰å¾… DOM å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLogViewer);
        } else {
            initLogViewer();
        }
    </script>
</body>

</html>